pipeline {
  agent any
  options {
    disableConcurrentBuilds()
  }
  stages {
    stage('Build') {
        environment {
            LOCALITY_BOT_TOKEN  = credentials('LOCALITY_BOT_TOKEN')
            LOCALITY_GROUP_ID   = credentials('LOCALITY_GROUP_ID')
        }
        steps {
            sh 'yarn'
            sh 'yarn build'
            sh 'make compose-up-ci'
            sh 'make compose-composer-ci'
            dir('api'){
            writeFile file: '.env', text: """
LOCALITY_BOT_TOKEN=${LOCALITY_BOT_TOKEN}
LOCALITY_GROUP_ID=${LOCALITY_GROUP_ID}
APP_ENV=prod
"""
            }
        }
    }
    stage('Deploy') {
        environment {
            FRONTEND_HOST  = credentials('FRONTEND_HOST')
        }
        steps {
            writeFile file: 'hosts', text: """
$FRONTEND_HOST
"""
            ansiblePlaybook(
                  playbook: 'infrastructure/deploy.yml',
                  inventory: "hosts",
                  credentialsId: "SSH_PRIVATE_KEY",
                  hostKeyChecking: false
            )
        }
    }
  }
  post {
    always {
      sh 'make compose-down-ci'
      notifyBuild(currentBuild.result)
    }
  }
}

def notifyBuild(def buildStatus) {
    buildStatus =  buildStatus ?: 'SUCCESS'
    GIT_COMMIT_MSG = sh (
        script: "git log --format=format:%s -1 ${GIT_COMMIT}",
        returnStdout: true
    ).trim()
    def emojiMap = [ 'STARTED': '#F0FFFF', 'SUCCESS': 'âœ…', 'FAILURE': 'ðŸ›‘' ]
    telegramSend """
${emojiMap[buildStatus]} *${JOB_NAME}* - ${buildStatus}
${env.RUN_DISPLAY_URL}
${GIT_COMMIT_MSG}
    """
}

